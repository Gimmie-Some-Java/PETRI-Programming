# U and W Axis Control System
# Provides G-code-like control for manual steppers

[gcode_macro _UW_INIT]
description: Initialize U and W axes
gcode:
    {% set ns = namespace(u_pos=0.0, w_pos=0.0, u_homed=False, w_homed=False) %}
    SET_GCODE_VARIABLE MACRO=_UW_STATUS VARIABLE=u_pos VALUE={ns.u_pos}
    SET_GCODE_VARIABLE MACRO=_UW_STATUS VARIABLE=w_pos VALUE={ns.w_pos}
    SET_GCODE_VARIABLE MACRO=_UW_STATUS VARIABLE=u_homed VALUE={ns.u_homed}
    SET_GCODE_VARIABLE MACRO=_UW_STATUS VARIABLE=w_homed VALUE={ns.w_homed}
    MANUAL_STEPPER STEPPER=stepper_u ENABLE=1
    MANUAL_STEPPER STEPPER=stepper_w ENABLE=1

[gcode_macro _UW_STATUS]
description: Track U and W axis positions and homing status
variable_u_pos: 0.0
variable_w_pos: 0.0
variable_u_homed: False
variable_w_homed: False
gcode:
    # Status tracking macro

# Enhanced G1 command that supports U and W axes
[gcode_macro G1]
rename_existing: G1.1
description: Enhanced G1 with U and W axis support
gcode:
    {% set ns = namespace() %}
    {% set status = printer["gcode_macro _UW_STATUS"] %}
    
    # Parse U parameter
    {% if 'U' in params %}
        {% set u_target = params.U|float %}
        {% set ns.u_move = u_target - status.u_pos %}
        MANUAL_STEPPER STEPPER=stepper_u MOVE={u_target} SPEED={params.F|default(300)|int / 60}
        SET_GCODE_VARIABLE MACRO=_UW_STATUS VARIABLE=u_pos VALUE={u_target}
    {% endif %}
    
    # Parse W parameter
    {% if 'W' in params %}
        {% set w_target = params.W|float %}
        {% set ns.w_move = w_target - status.w_pos %}
        MANUAL_STEPPER STEPPER=stepper_w MOVE={w_target} SPEED={params.F|default(300)|int / 60}
        SET_GCODE_VARIABLE MACRO=_UW_STATUS VARIABLE=w_pos VALUE={w_target}
    {% endif %}
    
    # Execute standard XYZ+E move (build parameters manually)
    {% set g1_cmd = [] %}
    {% if 'X' in params %}
        {% set g1_cmd = g1_cmd + ['X' + params.X] %}
    {% endif %}
    {% if 'Y' in params %}
        {% set g1_cmd = g1_cmd + ['Y' + params.Y] %}
    {% endif %}
    {% if 'Z' in params %}
        {% set g1_cmd = g1_cmd + ['Z' + params.Z] %}
    {% endif %}
    {% if 'E' in params %}
        {% set g1_cmd = g1_cmd + ['E' + params.E] %}
    {% endif %}
    {% if 'F' in params %}
        {% set g1_cmd = g1_cmd + ['F' + params.F] %}
    {% endif %}
    
    {% if g1_cmd|length > 0 %}
        G1.1 {g1_cmd|join(' ')}
    {% endif %}

# Enhanced G28 command that supports U and W axes
[gcode_macro G28]
rename_existing: G28.1
description: Enhanced G28 with U and W axis support
gcode:
    {% set status = printer["gcode_macro _UW_STATUS"] %}
    
    # Check what parameters we have (excluding the G parameter)
    {% set has_X = 'X' in params %}
    {% set has_Y = 'Y' in params %}
    {% set has_Z = 'Z' in params %}
    {% set has_U = 'U' in params %}
    {% set has_W = 'W' in params %}
    {% set has_E = 'E' in params %}
    
    # Build parameter lists
    {% set standard_axes = [] %}
    {% if has_X %}
        {% set standard_axes = standard_axes + ['X'] %}
    {% endif %}
    {% if has_Y %}
        {% set standard_axes = standard_axes + ['Y'] %}
    {% endif %}
    {% if has_Z %}
        {% set standard_axes = standard_axes + ['Z'] %}
    {% endif %}
    {% if has_E %}
        {% set standard_axes = standard_axes + ['E'] %}
    {% endif %}
    
    {% set uw_axes = [] %}
    {% if has_U %}
        {% set uw_axes = uw_axes + ['U'] %}
    {% endif %}
    {% if has_W %}
        {% set uw_axes = uw_axes + ['W'] %}
    {% endif %}
    
    # All parameter detection working correctly
    
    # Execute standard axis homing
    {% if standard_axes|length == 0 and uw_axes|length == 0 %}
        # No parameters = home all standard axes
        G28.1
    {% elif standard_axes|length > 0 %}
        # Specific standard axes requested
        G28.1 {standard_axes|join(' ')}
    {% endif %}
    
    # Handle U axis homing
    {% if has_U %}
        RESPOND MSG="Homing U axis..."
        MANUAL_STEPPER STEPPER=stepper_u ENABLE=1
        {% if printer.configfile.config["manual_stepper stepper_u"].endstop_pin is defined %}
            MANUAL_STEPPER STEPPER=stepper_u SYNC=0
            MANUAL_STEPPER STEPPER=stepper_u MOVE=-170 STOP_ON_ENDSTOP=1 SPEED=20 SYNC=0
            MANUAL_STEPPER STEPPER=stepper_u SET_POSITION=0 SYNC=0
            MANUAL_STEPPER STEPPER=stepper_u MOVE=2 SPEED=5 SYNC=0
            MANUAL_STEPPER STEPPER=stepper_u MOVE=-1 STOP_ON_ENDSTOP=1 SPEED=5 SYNC=0
            MANUAL_STEPPER STEPPER=stepper_u SET_POSITION=0 SYNC=1
            SET_GCODE_VARIABLE MACRO=_UW_STATUS VARIABLE=u_pos VALUE=0
            SET_GCODE_VARIABLE MACRO=_UW_STATUS VARIABLE=u_homed VALUE=True
            RESPOND MSG="U axis homed at endstop"
        {% else %}
            MANUAL_STEPPER STEPPER=stepper_u SET_POSITION=0
            SET_GCODE_VARIABLE MACRO=_UW_STATUS VARIABLE=u_pos VALUE=0
            SET_GCODE_VARIABLE MACRO=_UW_STATUS VARIABLE=u_homed VALUE=True
            RESPOND MSG="U axis position reset (no endstop)"
        {% endif %}
    {% endif %}
    
    # Handle W axis homing (individual or simultaneous with Z)
    {% if has_W %}
        {% if has_Z %}
            RESPOND MSG="Performing simultaneous Z+W homing..."
            # Z was already homed above, now home W
        {% else %}
            RESPOND MSG="Homing W axis..."
        {% endif %}
        MANUAL_STEPPER STEPPER=stepper_w ENABLE=1
        {% if printer.configfile.config["manual_stepper stepper_w"].endstop_pin is defined %}
            MANUAL_STEPPER STEPPER=stepper_w SYNC=0
            MANUAL_STEPPER STEPPER=stepper_w MOVE=-200 STOP_ON_ENDSTOP=1 SPEED=20 SYNC=0
            MANUAL_STEPPER STEPPER=stepper_w SET_POSITION=0 SYNC=0
            MANUAL_STEPPER STEPPER=stepper_w MOVE=5 SPEED=5 SYNC=0
            MANUAL_STEPPER STEPPER=stepper_w MOVE=-5 STOP_ON_ENDSTOP=1 SPEED=5 SYNC=0
            MANUAL_STEPPER STEPPER=stepper_w SET_POSITION=0 SYNC=1
            SET_GCODE_VARIABLE MACRO=_UW_STATUS VARIABLE=w_pos VALUE=0
            SET_GCODE_VARIABLE MACRO=_UW_STATUS VARIABLE=w_homed VALUE=True
            RESPOND MSG="W axis homed at endstop"
        {% else %}
            MANUAL_STEPPER STEPPER=stepper_w SET_POSITION=0
            SET_GCODE_VARIABLE MACRO=_UW_STATUS VARIABLE=w_pos VALUE=0
            SET_GCODE_VARIABLE MACRO=_UW_STATUS VARIABLE=w_homed VALUE=True
            RESPOND MSG="W axis position reset (no endstop)"
        {% endif %}
        {% if has_Z %}
            RESPOND MSG="Z+W simultaneous homing complete"
        {% endif %}
    {% endif %}

# Position reporting
[gcode_macro M114]
rename_existing: M114.1
description: Enhanced position report with U and W axes
gcode:
    {% set status = printer["gcode_macro _UW_STATUS"] %}
    M114.1
    {% set u_pos = status.u_pos|round(3) %}
    {% set w_pos = status.w_pos|round(3) %}
    RESPOND MSG="U:{u_pos} W:{w_pos}"

# Emergency stop for all axes
[gcode_macro M112]
rename_existing: M112.1
description: Enhanced emergency stop including U and W axes
gcode:
    M112.1
    MANUAL_STEPPER STEPPER=stepper_u ENABLE=0
    MANUAL_STEPPER STEPPER=stepper_w ENABLE=0
    SET_GCODE_VARIABLE MACRO=_UW_STATUS VARIABLE=u_homed VALUE=False
    SET_GCODE_VARIABLE MACRO=_UW_STATUS VARIABLE=w_homed VALUE=False

# Motors off including U and W
[gcode_macro M18]
rename_existing: M18.1
description: Enhanced motors off including U and W axes
gcode:
    {% if params.keys()|length == 0 %}
        # No parameters = disable all
        M18.1
        MANUAL_STEPPER STEPPER=stepper_u ENABLE=0
        MANUAL_STEPPER STEPPER=stepper_w ENABLE=0
        SET_GCODE_VARIABLE MACRO=_UW_STATUS VARIABLE=u_homed VALUE=False
        SET_GCODE_VARIABLE MACRO=_UW_STATUS VARIABLE=w_homed VALUE=False
    {% else %}
        # Selective disable
        {% if 'U' in params %}
            MANUAL_STEPPER STEPPER=stepper_u ENABLE=0
            SET_GCODE_VARIABLE MACRO=_UW_STATUS VARIABLE=u_homed VALUE=False
        {% endif %}
        {% if 'W' in params %}
            MANUAL_STEPPER STEPPER=stepper_w ENABLE=0
            SET_GCODE_VARIABLE MACRO=_UW_STATUS VARIABLE=w_homed VALUE=False
        {% endif %}
        # Handle standard axes
        {% set standard_params = [] %}
        {% for param in params %}
            {% if param not in ['U', 'W'] %}
                {% set standard_params = standard_params + [param] %}
            {% endif %}
        {% endfor %}
        {% if standard_params|length > 0 %}
            M18.1 {standard_params|join(' ')}
        {% endif %}
    {% endif %}

# Initialization on startup
[delayed_gcode UW_AXES_INIT]
initial_duration: 2.0
gcode:
    _UW_INIT
    RESPOND MSG="5-axis XYZUW control system initialized"
