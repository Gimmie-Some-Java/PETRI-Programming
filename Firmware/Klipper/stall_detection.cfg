# Stall Detection Configuration and Testing
# Provides backup safety and testing for TMC2209 stall detection

#########################################
# STALL DETECTION TEST MACROS
#########################################

[gcode_macro TEST_STALL_X]
description: Test X axis stall detection threshold
gcode:
    {% set threshold = params.THRESHOLD|default(100)|int %}
    RESPOND MSG="Testing X axis stall detection with threshold {threshold}"
    
    # Set stall threshold
    SET_TMC_FIELD STEPPER=stepper_x FIELD=SGTHRS VALUE={threshold}
    
    # Enable stepper and use FORCE_MOVE to bypass software limits
    SET_STEPPER_ENABLE STEPPER=stepper_x ENABLE=1
    FORCE_MOVE STEPPER=stepper_x DISTANCE=-300 VELOCITY=20
    
    RESPOND MSG="X axis stall test complete"

[gcode_macro TEST_STALL_Y]
description: Test Y axis stall detection threshold
gcode:
    {% set threshold = params.THRESHOLD|default(100)|int %}
    RESPOND MSG="Testing Y axis stall detection with threshold {threshold}"
    
    SET_TMC_FIELD STEPPER=stepper_y FIELD=SGTHRS VALUE={threshold}
    
    SET_STEPPER_ENABLE STEPPER=stepper_y ENABLE=1
    FORCE_MOVE STEPPER=stepper_y DISTANCE=-300 VELOCITY=20
    
    RESPOND MSG="Y axis stall test complete"

[gcode_macro TEST_STALL_Z]
description: Test Z axis stall detection threshold
gcode:
    {% set threshold = params.THRESHOLD|default(100)|int %}
    RESPOND MSG="Testing Z axis stall detection with threshold {threshold}"
    
    SET_TMC_FIELD STEPPER=stepper_z FIELD=SGTHRS VALUE={threshold}
    
    SET_STEPPER_ENABLE STEPPER=stepper_z ENABLE=1
    FORCE_MOVE STEPPER=stepper_z DISTANCE=-300 VELOCITY=10
    
    RESPOND MSG="Z axis stall test complete"

[gcode_macro TEST_STALL_U]
description: Test U axis stall detection threshold
gcode:
    {% set threshold = params.THRESHOLD|default(100)|int %}
    RESPOND MSG="Testing U axis stall detection with threshold {threshold}"
    
    # Manual steppers use different syntax
    MANUAL_STEPPER STEPPER=stepper_u SET_POSITION=0
    MANUAL_STEPPER STEPPER=stepper_u MOVE=-100 SPEED=20
    
    RESPOND MSG="U axis stall test complete"

[gcode_macro TEST_STALL_W]
description: Test W axis stall detection threshold  
gcode:
    {% set threshold = params.THRESHOLD|default(100)|int %}
    RESPOND MSG="Testing W axis stall detection with threshold {threshold}"
    
    MANUAL_STEPPER STEPPER=stepper_w SET_POSITION=0
    MANUAL_STEPPER STEPPER=stepper_w MOVE=-100 SPEED=20
    
    RESPOND MSG="W axis stall test complete"

#########################################
# STALL THRESHOLD ADJUSTMENT
#########################################

[gcode_macro SET_STALL_THRESHOLDS]
description: Set stall detection thresholds for all axes
gcode:
    {% set x_thresh = params.X|default(100)|int %}
    {% set y_thresh = params.Y|default(100)|int %}
    {% set z_thresh = params.Z|default(100)|int %}
    {% set u_thresh = params.U|default(100)|int %}
    {% set w_thresh = params.W|default(100)|int %}
    
    RESPOND MSG="Setting stall thresholds: X={x_thresh} Y={y_thresh} Z={z_thresh} U={u_thresh} W={w_thresh}"
    
    SET_TMC_FIELD STEPPER=stepper_x FIELD=SGTHRS VALUE={x_thresh}
    SET_TMC_FIELD STEPPER=stepper_y FIELD=SGTHRS VALUE={y_thresh}
    SET_TMC_FIELD STEPPER=stepper_z FIELD=SGTHRS VALUE={z_thresh}
    # Note: Manual steppers may need different approach for stall threshold setting
    
    RESPOND MSG="Stall thresholds updated"

[gcode_macro GET_STALL_STATUS]
description: Display current stall detection status for all axes
gcode:
    RESPOND MSG="=== STALL DETECTION STATUS ==="
    DUMP_TMC STEPPER=stepper_x
    DUMP_TMC STEPPER=stepper_y  
    DUMP_TMC STEPPER=stepper_z
    DUMP_TMC STEPPER=stepper_u
    DUMP_TMC STEPPER=stepper_w

#########################################
# SENSORLESS HOMING (BACKUP METHOD)
#########################################

[gcode_macro SENSORLESS_HOME_X]
description: Home X axis using stall detection (backup method)
gcode:
    RESPOND MSG="Sensorless homing X axis..."
    
    # Set appropriate stall threshold for homing
    SET_TMC_FIELD STEPPER=stepper_x FIELD=SGTHRS VALUE=80
    
    # Enable stepper
    SET_STEPPER_ENABLE STEPPER=stepper_x ENABLE=1
    
    # Use FORCE_MOVE since axis isn't homed yet
    FORCE_MOVE STEPPER=stepper_x DISTANCE=-300 VELOCITY=10  # Move until stall
    G4 P100                                                 # Brief pause
    FORCE_MOVE STEPPER=stepper_x DISTANCE=5 VELOCITY=5     # Back off
    FORCE_MOVE STEPPER=stepper_x DISTANCE=-10 VELOCITY=2   # Slow final approach
    
    # Set home position
    SET_KINEMATIC_POSITION X=0
    
    # Restore normal stall threshold
    SET_TMC_FIELD STEPPER=stepper_x FIELD=SGTHRS VALUE=100
    
    RESPOND MSG="X axis sensorless homing complete"

[gcode_macro SENSORLESS_HOME_ALL]
description: Emergency sensorless homing for all axes (if endstops fail)
gcode:
    RESPOND MSG="=== EMERGENCY SENSORLESS HOMING ==="
    RESPOND MSG="WARNING: Using stall detection instead of endstops!"
    
    # Lower stall thresholds for homing sensitivity
    SET_STALL_THRESHOLDS X=80 Y=80 Z=80
    
    # Enable all steppers
    SET_STEPPER_ENABLE STEPPER=stepper_x ENABLE=1
    SET_STEPPER_ENABLE STEPPER=stepper_y ENABLE=1
    SET_STEPPER_ENABLE STEPPER=stepper_z ENABLE=1
    
    # Home Y first using FORCE_MOVE
    RESPOND MSG="Homing Y axis with stall detection..."
    FORCE_MOVE STEPPER=stepper_y DISTANCE=-300 VELOCITY=10
    G4 P100
    FORCE_MOVE STEPPER=stepper_y DISTANCE=5 VELOCITY=5
    FORCE_MOVE STEPPER=stepper_y DISTANCE=-10 VELOCITY=2
    SET_KINEMATIC_POSITION Y=0
    
    # Home X and Z using FORCE_MOVE
    RESPOND MSG="Homing X and Z axes with stall detection..."
    FORCE_MOVE STEPPER=stepper_x DISTANCE=-300 VELOCITY=10
    FORCE_MOVE STEPPER=stepper_z DISTANCE=-300 VELOCITY=10
    G4 P100  
    FORCE_MOVE STEPPER=stepper_x DISTANCE=5 VELOCITY=5
    FORCE_MOVE STEPPER=stepper_z DISTANCE=5 VELOCITY=5
    FORCE_MOVE STEPPER=stepper_x DISTANCE=-10 VELOCITY=2
    FORCE_MOVE STEPPER=stepper_z DISTANCE=-10 VELOCITY=2
    SET_KINEMATIC_POSITION X=0 Z=0
    
    # Home U and W
    RESPOND MSG="Homing U and W axes with stall detection..."
    MANUAL_STEPPER STEPPER=stepper_u MOVE=-100 SPEED=10
    MANUAL_STEPPER STEPPER=stepper_u SET_POSITION=0
    MANUAL_STEPPER STEPPER=stepper_w MOVE=-100 SPEED=10
    MANUAL_STEPPER STEPPER=stepper_w SET_POSITION=0
    
    # Restore normal stall thresholds
    SET_STALL_THRESHOLDS X=100 Y=100 Z=100
    
    RESPOND MSG="Emergency sensorless homing complete"
    RESPOND MSG="CAUTION: Verify positions before normal operation!"

#########################################
# COLLISION DETECTION
#########################################

[gcode_macro ENABLE_COLLISION_DETECTION]
description: Enable stall detection during normal moves for collision detection
gcode:
    RESPOND MSG="Enabling collision detection on all axes"
    
    # Set sensitive thresholds for collision detection
    SET_STALL_THRESHOLDS X=120 Y=120 Z=120
    
    RESPOND MSG="Collision detection active - motors will stop if they encounter resistance"

[gcode_macro DISABLE_COLLISION_DETECTION]  
description: Disable collision detection (normal operation)
gcode:
    RESPOND MSG="Disabling collision detection"
    
    # Set normal thresholds
    SET_STALL_THRESHOLDS X=100 Y=100 Z=100
    
    RESPOND MSG="Collision detection disabled - normal operation"